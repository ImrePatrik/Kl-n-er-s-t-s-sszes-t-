// Készítő: Patika30

(async () => {
    const unitNames = [
        'Lándzsás', 'Kardforgató', 'Bárdos', 'Íjász',
        'Kém', 'Könnyűlovas', 'Lovas íjász', 'Nehézlovas',
        'Faltörő kos', 'Katapult', 'Lovag', 'Főnemes', 'Milícia'
    ];

    // Saját fióknév kinyerése a game_data objektumból, ha elérhető
    const sajatNev = (typeof game_data === 'object' && game_data.player && game_data.player.name)
        ? game_data.player.name.trim()
        : 'Saját fiók';

    const rows = document.querySelectorAll('tr[class^="village_row_"]');
    let playerTotals = {};

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length < 2) return;

        const links = cells[0].querySelectorAll('a');

        // Ha nincs két link, vagy más fiók neve nincs megadva, akkor saját név (saját faluban lévő erősítés)
        let playerText = (links.length < 2 || !links[1].textContent.trim()) ? sajatNev : links[1].textContent.trim();

        // Fióknév zárójel esetén kiolvasás (más fiókok)
        const parenStart = playerText.indexOf('(');
        const parenEnd = playerText.indexOf(')');
        let player = '';
        if (parenStart !== -1 && parenEnd !== -1 && parenEnd > parenStart) {
            player = playerText.substring(parenStart + 1, parenEnd).trim();
        } else {
            player = playerText;
        }

        if (!player) return;

        const unitsRaw = Array.from(cells).slice(1, unitNames.length + 1).map(td => parseInt(td.textContent.trim()) || 0);
        if (unitsRaw.every(n => n === 0)) return;

        if (!playerTotals[player]) {
            playerTotals[player] = new Array(unitNames.length).fill(0);
        }
        unitsRaw.forEach((num, idx) => {
            playerTotals[player][idx] += num;
        });
    });

    // Régi modal és overlay eltávolítása, ha léteznek
    let existingModal = document.getElementById('clanReinforcementsModal');
    if (existingModal) existingModal.remove();
    let existingOverlay = document.getElementById('clanReinforcementsOverlay');
    if (existingOverlay) existingOverlay.remove();

    const modal = document.createElement('div');
    modal.id = 'clanReinforcementsModal';
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.backgroundColor = '#edd3a1';
    modal.style.border = '2px solid #444';
    modal.style.padding = '20px';
    modal.style.zIndex = 10000;
    modal.style.maxHeight = '80vh';
    modal.style.overflowY = 'auto';
    modal.style.width = '90vw';
    modal.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';

    let html = `<h2 style="margin-top:0">Klán Erősítés Összesítő</h2>`;
    html += `<button id="closeReinforcementsModal" style="float:right; margin-bottom:10px;">Bezárás</button>`;
    html += `<table style="border-collapse: collapse; width: 100%;">`;
    html += `<thead><tr><th style="border: 2px solid #fff; padding:5px; text-align:center;">Fiók</th>`;
    unitNames.forEach(name => {
        html += `<th style="border: 2px solid #fff; padding:5px; text-align:center;">${name}</th>`;
    });
    html += `</tr></thead><tbody>`;

    for (const player in playerTotals) {
        html += `<tr><td style="border: 2px solid #fff; padding:5px; font-weight:bold; text-align:center;">${player}</td>`;
        playerTotals[player].forEach(num => {
            html += `<td style="border: 2px solid #fff; padding:5px; text-align:center;">${num > 0 ? num : ''}</td>`;
        });
        html += `</tr>`;
    }

    html += `</tbody></table>`;
    modal.innerHTML = html;

    modal.querySelector('#closeReinforcementsModal').onclick = () => {
        modal.remove();
        const overlay = document.getElementById('clanReinforcementsOverlay');
        if (overlay) overlay.remove();
    };

    const overlay = document.createElement('div');
    overlay.id = 'clanReinforcementsOverlay';
    overlay.style.position = 'fixed';
    overlay.style.top = 0;
    overlay.style.left = 0;
    overlay.style.width = '100vw';
    overlay.style.height = '100vh';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.3)';
    overlay.style.zIndex = 9999;
    overlay.onclick = () => {
        modal.remove();
        overlay.remove();
    };

    document.body.appendChild(overlay);
    document.body.appendChild(modal);
})();
